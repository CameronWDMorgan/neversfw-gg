<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generator | NeverSFW.gg</title>
    <meta name="description" content="A hub for NSFW Images, Videos & Games!">
    <meta name="keywords" content="nsfw, Porn, Hentai, rule34, r34, ai, image, image generator, dalle-3, stable diffusion">
    <meta name="author" content="MiningP">
    <meta name="juicyads-site-verification" content="da00b2314e338e83450b5bf9040a1fa6">
    
    <link rel="stylesheet" href="../betasite.css">

    <style>
        li{
            list-style-type:square;
        }
        .form-control {
            margin-bottom: 1rem;
        }
        .form-control label,
        .form-control input,
        .form-control textarea,
        .form-control span {
            display: block;
        }
        .form-control input[type="text"],
        .form-control input[type="range"],
        .form-control textarea,
        .form-control button {
            width: 100%;
            margin-top: 0.5rem;
            resize: none;
        }
        .form-control span {
            margin-top: 0.5rem;
            font-weight: bold;
        }
        #generatorForm {
            max-width: 600px;
            margin: auto;
        }
        .range-value {
            text-align: center;
        }
        #generateButton {
            background-color: #4caf4f95; /* Green */
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            transition: transform 0.7s, background-color 0.3s; /* Adjust time as needed */
            transform: scale(1) rotate(0deg); /* Default state */
            transform-origin: center; /* Ensures the scaling happens from the center */
        }

        #generateButton:hover {
            transform: scale(1.08) rotate(1deg); 
            background-color: #4CAF50; /* Green */
        }
        #generateButton:active {
            transform: scale(1.1);
            background-color: #ffe600; /* Red */
        }
        #generateButton.generating {
            background-color: #ff0000; /* Red */
            cursor:not-allowed;
        }
        #generateButton.generating:hover {
            transform: scale(0.7) rotate(-1deg); 
        }
        img#generatedImage {
            max-width: 100%;
            height: auto;
            display: block; /* added display block to remove bottom margin of image */
            margin-top: 2rem;
        }
        .instructions ul {
            text-align: left;
        }
        .center-content {
            text-align: center;
        }
        /* This will ensure your custom highlight styling has precedence */
        .ui-menu-item-wrapper{
            border-radius: 1px;
            border-color: rgba(0, 0, 0, 0.279);
            border-style: solid;
            width: fit-content;
        }
        .custom-highlight {
            background-color: rgba(229, 255, 0, 0.25) !important; /* Example color, use !important to ensure override */
            text-decoration: solid !important;
            border-color: gold !important;
            width: fit-content;
        }
        .autocomplete-space {
            margin-top: 0px !important; /* Adjust this value based on your needs */
        }
        .autocomplete-open {
            margin-top: 105px !important; /* Adjust this value based on your needs */
        }


    </style>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FFEW0Y6QFQ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FFEW0Y6QFQ');
    </script>
</head>
<body>

    <%- include('../partials/_popunder'); -%>

    <div class="page-sidebar">
        <!-- Side Navigation Partial -->
        <%- include('../partials/_sideNav'); -%>
    </div>

    <div class="page-left" style="margin-top: 22rem;">
        <!-- Tower Advert Partial -->
        <%- include('../partials/_towerAdvert'); -%>
    </div>

    <div class="page-right">
        <div class="center-content">
                    
            <img src="https://www.neversfw.gg/nsfwlogobanner.png" style="max-width: 100%; height: auto;">
            <br>
            <br>
                <%- include('../partials/_bannerAdvert'); -%>
            
            <br><br>
            <%- include('../partials/_mobileNavigation'); -%>
            <!-- Banner Advert Partial -->
        </div>

        <div class="round-frosted">

            <div class="instructions">
                <h2>Welcome to the AI Image Generator!</h2>
                <p>Information on how to use it!</p>
                <ul>
                    <li>Prompt: Enter a descriptive and clear text prompt that outlines what you want to generate. Be as specific as possible to get the best results & be sure to use the autocomplete dropdown!</li><br>
                    <li>Negative Prompt: If there are elements you want to avoid in your image, specify them here.</li><br>
                    <li>Width and Height Sliders: Adjust these sliders to set the dimensions of your generated image.</li><br>
                    <li>Steps Slider: This controls the number of steps the diffusion process will take. A higher number of steps can result in more detailed images but may take longer to generate.</li><br>
                </ul>
            </div>

            <form id="generatorForm" class="autocomplete-space">
                <div class="form-control">
                    <label for="prompt">Prompt:</label>
                    <textarea id="prompt" name="prompt" rows="3" required></textarea>
                </div>
                
                <div class="form-control">
                    <label for="negativeprompt">Negative Prompt (Optional):</label>
                    <input type="text" id="negativeprompt" name="negativeprompt">
                </div>
                
                <div class="form-control">
                    <label for="width">Width:</label>
                    <span id="widthValue" class="range-value">512</span>
                    <input class="resolution" type="range" id="width" name="width" min="512" max="1024" step="256" value="512" data-output="widthValue">
                </div>

                <div class="form-control">
                    <label for="height">Height:</label>
                    <span id="heightValue" class="range-value">512</span>
                    <input class="resolution" type="range" id="height" name="height" min="512" max="1024" step="256" value="512" data-output="heightValue">
                </div>

                <div class="form-control">
                    <label for="steps">Steps:</label>
                    <span id="stepsValue" class="range-value">20</span>
                    <input type="range" id="steps" name="steps" min="20" max="100" step="5" value="20" data-output="stepsValue">
                </div>

                <center>
                    <h2>Be sure to send your best Images to the</h2>
                    <a href="https://discord.gg/2QXV66RVMG" style="font-size: xx-large; color: gold; text-decoration: underline;">Discord Server</a>
                    <br><br>
                </center>
                
                <div class="form-control">
                    <button type="submit" id="generateButton">Generate Image</button>
                </div>
            </form>
            
            <center>
                <div id="response"></div>
                <div id="queuePosition" style="display: none;">Your position in queue: <span style="color: gold;" id="positionNumber"></span></div>
                <img id="generatedImage" src="" alt="Generated Image" style="display:none;">
            </center>
        </div>


        <div style="height: 20rem;"></div>

        <!-- Footer Partial -->
        <%- include('../partials/_footerNew'); -%>
        
    </div>
    
    <script src="../javascript/ai/slider-adjustment.js"></script>
    <script src="../javascript/ai/form-processing.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
    <script>
        $(document).ready(function() {
            function split(val) {
                return val.split(/,\s*/);
            }
            function extractLast(term) {
                return split(term).pop();
            }

            $('#prompt').on("keydown", function(event) {
                if (event.keyCode === $.ui.keyCode.TAB && $(this).autocomplete("instance").menu.active) {
                    event.preventDefault();
                }
            }).autocomplete({
                source: function(request, response) {
                    $.ajax({
                        url: '/autocomplete',
                        dataType: 'json',
                        data: {
                            term: extractLast(request.term)
                        },
                        success: function(data) {
                            response(data);
                        }
                    });
                },
                open: function( event, ui ) {
                    console.log($(this).closest('form'))
                    $(this).closest('form').addClass('autocomplete-open');
                },
                close: function( event, ui ) {
                    $(this).closest('form').removeClass('autocomplete-open');
                },
                search: function() {
                    var term = extractLast(this.value);
                    if (term.length < 2) {
                        return false;
                    }
                },
                focus: function (event, ui) {
                    // prevent value inserted on focus
                    event.preventDefault();
                    
                    // Get the autocomplete widget menu element
                    var menu = $(this).data('ui-autocomplete').menu.element;

                    // Remove highlight from any previously focused item
                    menu.find('li').removeClass('custom-highlight');
                    
                    // Find the index of the currently focused item
                    var index = ui.item ? menu.find('li:contains("' + ui.item.value + '")').index() : -1;

                    // Add highlight to the currently focused item if it exists
                    if(index !== -1){
                        menu.find('li').eq(index).addClass('custom-highlight');
                    }
                },
                select: function(event, ui) {
                    var terms = split(this.value);
                    // remove the current input
                    terms.pop();
                    // add the selected item
                    actual_tag = ui.item.value.replace(/ \(\d+\)/g, '');
                    actual_tag = actual_tag.replace(/_/g, " ");
                    actual_tag = actual_tag.trim()
                    terms.push(actual_tag);
                    // add placeholder to get the comma-and-space at the end
                    terms.push("");
                    this.value = terms.join(", ");
                    return false;
                },
                position: { my: "left+50 bottom", at: "left top-20", collision: "none" },
            }).data('ui-autocomplete')._renderItem = function (ul, item) {
                // Highlight the matching part
                var term = extractLast(this.term);
                var re = new RegExp("(" + $.ui.autocomplete.escapeRegex(term) + ")", "gi");
                var highlightedValue = item.label.replace(re, "<strong>$1</strong>");
                return $("<li>")
                    .addClass('ui-menu-item') // Ensure this is consistent with jQuery UI's default classing
                    .append("<div class='ui-menu-item-wrapper'>" + highlightedValue + "</div>")
                    .appendTo(ul);
            };
            // Reset styles when the menu is closed
            $('#prompt').on('autocompleteclose', function () {
                $(this).data('ui-autocomplete').menu.element.find('li').css({
                    'background-color': '',
                    'color': '',
                    'font-weight': ''
                });
            });



            // Function to wrap or modify the word around the cursor with the example tag
    function wrapOrModifyWordAroundCursor(increment) {
        var textarea = $('#prompt');
        var text = textarea.val();
        var cursorPos = textarea.get(0).selectionStart;
        
        // Regular expression to match the word at the cursor with optional wrapping
        var wordAtCursorRegex = /(?:\((\w+):(\d+\.\d+)\))|(\b\w+\b)/g;
        
        // Function to find the word at the cursor position
        var findWordAtCursor = function(text, cursorPos) {
            var result = { word: '', number: 1.1, isWrapped: false, startIndex: -1, endIndex: -1 };
            var match;
            
            // Reset the lastIndex of the regex to ensure proper search
            wordAtCursorRegex.lastIndex = 0;
            
            while ((match = wordAtCursorRegex.exec(text)) !== null) {
                var matchStart = match.index;
                var matchEnd = wordAtCursorRegex.lastIndex;
                
                // Check if the cursor is within the current match
                if (cursorPos >= matchStart && cursorPos < matchEnd) {
                    result.word = match[1] || match[3];
                    result.number = match[2] ? parseFloat(match[2]) : 1.1;
                    result.isWrapped = !!match[1];
                    result.startIndex = matchStart;
                    result.endIndex = matchEnd;
                    break;
                }
            }
            
            return result;
        };

        var wordDetails = findWordAtCursor(text, cursorPos);
        
        if (wordDetails.word) {
            var newWord;
            var newCursorPos;
            
            if (wordDetails.isWrapped) {
                // Increment or decrement the number in the tag
                var newNumber = wordDetails.number + (increment ? 0.1 : -0.1);
                newNumber = Math.max(newNumber, 0); // Ensure the number is not negative
                newWord = '(' + wordDetails.word + ':' + newNumber.toFixed(1) + ')';
            } else {
                // Wrap the word with the tag
                newWord = '(' + wordDetails.word + ':1.1)';
            }

            // Replace the word in the text
            textarea.val(text.substring(0, wordDetails.startIndex) + newWord + text.substring(wordDetails.endIndex));
            
            // Set the cursor position just before the closing parenthesis
            newCursorPos = wordDetails.startIndex + newWord.length - 1;
            textarea.get(0).selectionStart = textarea.get(0).selectionEnd = newCursorPos;
        }
    }

    // Event handler for keydown event
    $('#prompt').on("keydown", function(event) {
        // Check if CTRL is pressed along with Up or Down arrow
        if (event.ctrlKey && (event.keyCode === 38 || event.keyCode === 40)) {
            event.preventDefault(); // Prevent the default action
            wrapOrModifyWordAroundCursor(event.keyCode === 38); // Pass true for Up arrow, false for Down arrow
        }
    });



        });
    </script>


</body>
</html>
